//
//  ConversationListView.swift
//  KaapehCopiloto2
//
//  Vista para mostrar el historial de conversaciones
//

import SwiftUI

struct ConversationListView: View {
    @ObservedObject var viewModel: VoiceChatViewModel
    @Binding var isPresented: Bool
    @State private var conversations: [Conversation] = []
    
    var body: some View {
        NavigationStack {
            List {
                ForEach(conversations) { conversation in
                Button(action: {
                    viewModel.loadConversation(conversation)
                    isPresented = false
                }) {
                    VStack(alignment: .leading) {
                        Text(conversation.title)
                            .font(.headline)
                        Text(conversation.formattedDate)
                            .font(.caption)
                            .foregroundColor(.secondary)
                    }
                }
                }
                .onDelete(perform: deleteConversations)
            }
            .navigationTitle("Historial de Conversaciones")
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .cancellationAction) {
                    Button("Cerrar") {
                        isPresented = false
                    }
                }
                
                ToolbarItem(placement: .primaryAction) {
                    Button("Nueva") {
                        viewModel.createNewConversation()
                        isPresented = false
                    }
                }
            }
            .onAppear {
                loadConversations()
            }
        }
    }
    
    private func loadConversations() {
        conversations = ConversationService.shared.fetchAllConversations()
    }
    
    private func deleteConversation(_ conversation: Conversation) {
        ConversationService.shared.delete(conversation)
        conversations.removeAll { $0.id == conversation.id }
    }
}

// MARK: - Conversation Row View
struct ConversationRowView: View {
    let conversation: Conversation
    let accessibilityManager: AccessibilityManager
    let onSelect: () -> Void
    let onDelete: () -> Void
    
    var body: some View {
        Button(action: onSelect) {
            HStack(spacing: 12) {
                // Icono con gradiente
                Image(systemName: "bubble.left.and.bubble.right.fill")
                    .font(.system(size: 24))
                    .foregroundStyle(
                        LinearGradient(
                            colors: [AppTheme.Colors.coffeeBrown, AppTheme.Colors.espresso],
                            startPoint: .top,
                            endPoint: .bottom
                        )
                    )
                    .frame(width: 48, height: 48)
                    .background(
                        Circle()
                            .fill(accessibilityManager.cardBackgroundColor.opacity(0.8))
                    )
                
                // Información
                VStack(alignment: .leading, spacing: 4) {
                    Text(conversation.title)
                        .font(.system(size: accessibilityManager.bodyFontSize, weight: .semibold))
                        .foregroundStyle(accessibilityManager.primaryTextColor)
                        .lineLimit(1)
                    
                    HStack(spacing: 6) {
                        Image(systemName: "clock")
                            .font(.system(size: 12))
                        Text(conversation.formattedDate)
                            .font(.system(size: accessibilityManager.captionFontSize))
                    }
                    .foregroundStyle(accessibilityManager.secondaryTextColor)
                }
                
                Spacer()
                
                // Botón de eliminar
                Button(action: onDelete) {
                    Image(systemName: "trash")
                        .font(.system(size: 16))
                        .foregroundStyle(.red)
                        .frame(width: 32, height: 32)
                        .background(
                            Circle()
                                .fill(Color.red.opacity(0.1))
                        )
                }
                .buttonStyle(.plain)
                
                // Chevron
                Image(systemName: "chevron.right")
                    .font(.system(size: 14, weight: .semibold))
                    .foregroundStyle(accessibilityManager.secondaryTextColor)
            }
            .padding(16)
            .background(
                RoundedRectangle(cornerRadius: 16)
                    .fill(accessibilityManager.cardBackgroundColor)
                    .shadow(color: .black.opacity(0.08), radius: 4, y: 2)
            )
        }
        .buttonStyle(.plain)
    }
}

private func setupCallbacks() {
        // ...existing code...
        
        // TTS: Cuando el asistente termina de hablar → VOLVER A IDLE (sin auto-loop)
        ttsManager.onSpeechFinished = { [weak self] in
            Task { @MainActor [weak self] in
                print("✅ TTS terminado")
                // NO volvemos a escuchar automáticamente
                // El usuario debe presionar el botón nuevamente
                self?.transition(to: .idle)
            }
        }
    }
